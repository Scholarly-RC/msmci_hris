{% extends "layout.html" %}
{% block content %}
    {% include "navbar.html" %}
    <div class="flex flex-col items-center px-4 2xl:px-0 pt-6 xl:gap-4 dark:bg-gray-900">
        <div class="w-full relative px-2 lg:px-10">
            <h1 class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white py-3 mt-10">Salary & Rank Management</h1>
            {% block salary_and_rank_management_section %}
                <div id="salary_and_rank_management_section"
                     class="h-[48rem] flex flex-col gap-6 p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-gray-800">
                    <div class="relative overflow-x-auto sm:rounded-lg">
                        <div class="flex flex-column sm:flex-row flex-wrap space-y-4 sm:space-y-0 items-center justify-between pb-4">
                            <div>
                                <form class="max-w-sm mx-auto">
                                    <label for="departments"
                                           class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                        Filter by Department
                                    </label>
                                    <select id="departments"
                                            name="selected_department"
                                            hx-post="{% url "payroll:salary_and_rank_management" %}"
                                            hx-trigger="change"
                                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                        <option selected value="0">All</option>
                                        {% for department in departments %}
                                            <option value="{{ department.id }}"
                                                    {% if selected_department == department.id %}selected{% endif %}>
                                                {{ department.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </div>
                            <button hx-get="{% url "payroll:add_job" %}"
                                    hx-swap="none"
                                    type="button"
                                    class="text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2.5 text-center me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                Add
                            </button>
                        </div>
                        {% block job_list_table %}
                            <table id="job_list_table"
                                   class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Name</th>
                                        <th scope="col" class="px-6 py-3 text-center">Code</th>
                                        <th scope="col" class="px-6 py-3 text-center">Salary Grade</th>
                                        <th scope="col" class="px-6 py-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in jobs %}
                                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <th scope="row"
                                                class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                                {{ job.title }}
                                            </th>
                                            <td class="px-6 py-4 text-center">{{ job.code }}</td>
                                            <td class="px-6 py-4 text-center">{{ job.salary_grade }}</td>
                                            <td class="px-6 py-4 text-center">
                                                <button type="button"
                                                        hx-post="{% url "payroll:view_job" %}"
                                                        hx-vals='{"job": {{ job.id }}}'
                                                        class="font-medium text-blue-600 dark:text-blue-500 hover:underline">
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endblock %}
                    </div>
                </div>
            {% endblock %}
            <div id="add_job_modal"
                 tabindex="-1"
                 aria-hidden="true"
                 class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                {% block add_job_modal_container %}
                    <div id="add_job_modal_container"
                         class="relative p-4 w-full max-w-2xl max-h-full">
                        <form hx-post="{% url "payroll:add_job" %}"
                              class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Add Job</h3>
                                <button hx-post="{% url "payroll:payroll_module_close_modals" %}"
                                        hx-vals='{"event_name": "closeAddJobModal"}'
                                        type="button"
                                        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                                    <svg class="w-3 h-3"
                                         aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
                            </div>
                            <div class="p-4 md:p-5 space-y-4">
                                <div class="max-w-md mx-auto">
                                    <div class="relative z-0 w-full mb-5 group">
                                        <input type="text"
                                               name="job_title"
                                               id="job_title"
                                               class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                                               placeholder=" "
                                               required />
                                        <label for="job_title"
                                               class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">
                                            Job Title
                                        </label>
                                    </div>
                                    <div class="relative z-0 w-full mb-5 group">
                                        <input type="text"
                                               name="job_code"
                                               id="job_code"
                                               class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                                               placeholder=" "
                                               required />
                                        <label for="job_code"
                                               class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">
                                            Job Code
                                        </label>
                                    </div>
                                    <div class="relative z-0 w-full mb-5 group">
                                        <label for="select_department_input"
                                               class="block mb-2 text-sm font-base text-gray-900 dark:text-white">
                                            Select a Department
                                        </label>
                                        <select id="select_department_input"
                                                name="selected_department"
                                                multiple
                                                required
                                                size="5"
                                                class="block py-2.5 px-0 w-full text-sm text-gray-500 bg-transparent border-0 border-b-2 border-gray-200 appearance-none dark:text-gray-400 dark:border-gray-700 focus:outline-none focus:ring-0 focus:border-gray-200 peer">
                                            {% for department in departments %}<option value="{{ department.id }}">{{ department.name }}</option>{% endfor %}
                                        </select>
                                    </div>
                                    <div class="grid md:grid-cols-2 md:gap-6">
                                        <div class="relative z-0 w-full mb-5 group">
                                            <div class="relative z-0 w-full mb-5 group">
                                                <input type="number"
                                                       name="salary_grade"
                                                       id="salary_grade"
                                                       class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer"
                                                       min="2"
                                                       max="10"
                                                       value="2"
                                                       required />
                                                <label for="salary_grade"
                                                       class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">
                                                    Salary Grade
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                                <button type="submit"
                                        type="button"
                                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                                    Submit
                                </button>
                                <button hx-post="{% url "payroll:payroll_module_close_modals" %}"
                                        hx-vals='{"event_name": "closeAddJobModal"}'
                                        type="button"
                                        class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                                    Close
                                </button>
                            </div>
                        </form>
                    </div>
                {% endblock %}
            </div>
            <div id="view_job_modal"
                 tabindex="-1"
                 aria-hidden="true"
                 class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                {% block view_job_modal_container %}
                    <div id="view_job_modal_container"
                         class="relative w-full max-w-7xl max-h-full">
                        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700 mx-4">
                            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{{ job.title|title }}</h3>
                                <button hx-post="{% url "payroll:payroll_module_close_modals" %}"
                                        hx-vals='{"event_name": "closeViewJobModal"}'
                                        type="button"
                                        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                                    <svg class="w-3 h-3"
                                         aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
                            </div>
                            <div class="p-4 md:p-5 space-y-4">
                                <div class="relative overflow-x-auto">
                                    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                            <tr class="text-center">
                                                <th scope="col" class="px-6 py-3">Salary Grade</th>
                                                <th scope="col" class="px-6 py-3">Rank</th>
                                                <th scope="col" class="px-6 py-3">Basic Salary</th>
                                                {% for step_header in job.get_number_of_steps_for_header %}
                                                    <th scope="col" class="px-6 py-3">{{ step_header }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for data in job.get_salary_data %}
                                                {% for key, value in data.items %}
                                                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 text-center">
                                                        <th scope="row"
                                                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                                            {{ value.salary_grade }}
                                                        </th>
                                                        <td class="px-6 py-4">{{ key }}</td>
                                                        <td class="px-6 py-4">{{ value.basic_salary }}</td>
                                                        {% for step in value.steps %}
                                                            <td class="px-6 py-4">
                                                                {% for key, value in step.items %}{{ value }}{% endfor %}
                                                            </td>
                                                        {% endfor %}
                                                    </tr>
                                                {% endfor %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                                <button hx-post="{% url "payroll:payroll_module_close_modals" %}"
                                        hx-vals='{"event_name": "closeViewJobModal"}'
                                        type="button"
                                        class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                {% endblock %}
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script>
        const initializeViewJobModal = () => {
            const modalElement = document.getElementById('view_job_modal');
            const options = {
                placement: 'center-center',
                backdrop: 'dynamic',
                backdropClasses: 'bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40',
                closable: true,
            };

            const instanceOptions = {
                id: 'view_job_modal',
                override: true
            };

            if (modalElement) {
                const modal = new Modal(modalElement, options, instanceOptions);
                modal.show();
            }
        }

        const closeViewJobModal = () => {
            const modalElement = document.getElementById('view_job_modal');

            if (modalElement) {
                const modal = new Modal(modalElement);
                modal.hide();
            }
        }

        document.addEventListener('openViewJobModal', (event) => {
            initializeViewJobModal();
        });

        document.addEventListener('closeViewJobModal', (event) => {
            closeViewJobModal();
        });
    </script>
    <script>
        const updateJobList = () => {
            const selected_department = document.getElementById('departments').value;

            htmx.ajax('POST', '{% url "payroll:update_job_list" %}', {
                values: {
                    "selected_department": selected_department,
                }
            })
        }
        const initializeAddJobModal = () => {
            const modalElement = document.getElementById('add_job_modal');
            const options = {
                placement: 'center-center',
                backdrop: 'dynamic',
                backdropClasses: 'bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40',
                closable: true,
            };

            const instanceOptions = {
                id: 'add_job_modal',
                override: true
            };

            if (modalElement) {
                const modal = new Modal(modalElement, options, instanceOptions);
                modal.show();
            }
        }

        const closeAddJobModal = () => {
            const modalElement = document.getElementById('add_job_modal');

            if (modalElement) {
                const modal = new Modal(modalElement);
                modal.hide();
            }
        }

        document.addEventListener('openAddJobModal', (event) => {
            initializeAddJobModal();
        });

        document.addEventListener('closeAddJobModal', (event) => {
            closeAddJobModal();
        });

        document.addEventListener('newJobAdded', (event) => {
            closeAddJobModal();
            updateJobList();
        });
    </script>
{% endblock %}
